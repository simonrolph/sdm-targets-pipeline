---
title: "Environmental data processing"
author: "Simon Rolph"
date: "`r Sys.Date()`"
output: html_document
---

This script prepares the environmental data (climate, land-use etc.)

This script is currently not run as part of the {targets} pipeline. An output file of this script are loaded into the pipeline as files. This output is a `.tif` file containing the environmental data for the target region and is saved in this location. `data/derived/environmental/env-layers-OSGB.tif` 

The are of interest (AOI) boundary, represented as well known text (WKT) is saved to `data/derived/environmental/AOI_WKT.txt`and used when querying GBIF.

Load packages

```{r}
library(sf)
library(terra)
```

Define extent

```{r}
AOI_boundary_file_location = "data/raw/boundaries/SG_CairngormsNationalPark_2010/SG_CairngormsNationalPark_2010.shp"

#read in the park boundary
boundary <- st_read(AOI_boundary_file_location)

#this outputs the bounding box which can be used in the GEE script
boundary %>% st_bbox()

#appriximate WKT of park with a bit of buffering
park_wkt <- boundary %>%
  st_buffer(10000) %>% # buffer by 10k
  st_transform(4326) %>% #transform to wgs1984
  st_simplify(dTolerance=1000) %>% # simplify
  st_geometry() %>% #only select the geometry to that st_as_text() works properly
  st_as_text()

#write the boundary of the AOI (area of interest) as WKT which can be used for querying GBIF
writeLines(park_wkt,"data/derived/environmental/AOI_WKT.txt")

```

Load layers which have been downloaded from google earth engine and reproject to OSGB

```{r}

bio_image <- "data/raw/environmental/bio-image.tif"
predictors_image <- "data/raw/environmental/predictors-image.tif"

#combine into one spatRaster
env_layers <- rast(c(bio_image,
                   predictors_image))

#project to OSGB
env_layers <- project(env_layers,"EPSG:27700")

#(optionally) mask to the park boundary
#env_layers <- env_layers %>% mask(boundary %>% st_buffer(10000))

env_layers

#save the raster  
writeRaster(env_layers,filename = "data/derived/environmental/env-layers-OSGB.tif")

```

